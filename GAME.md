# 游戏流程文档

## 1. 游戏加入流程

### 1.1 加入队列
- 玩家加入预定义的语音队列频道（在`QUEUES_ARRAY`中配置）
- 当队列频道满员时（默认8人），系统自动触发游戏创建流程

### 1.2 游戏创建
1. 系统调用`createNewGame()`创建新游戏实例
2. 为游戏创建专用的文本频道和语音频道
3. 验证所有玩家均已注册，否则提示错误并取消游戏
4. 随机选择两名队长并开始队伍选择流程

### 1.3 队伍选择
1. 系统随机选择两名队长
2. 队长轮流选择队员，直到所有玩家分配完毕
3. 创建两个队伍专用语音频道
4. 将玩家移动到对应的队伍频道

### 1.4 游戏准备
1. 系统为游戏分配机器人（Bot）
2. 如果没有可用机器人，游戏将被取消
3. 选择游戏地图
4. 将游戏状态设置为`STARTING`

## 2. 游戏进行流程

### 2.1 游戏开始
- 机器人连接到游戏服务器
- 游戏状态更新为`ACTIVE`
- 实际游戏开始

### 2.2 游戏监控
- 机器人监控游戏进程
- 收集玩家数据（击杀、死亡、破坏床数等）
- 检测违规行为（使用违禁物品、AFK等）

## 3. 游戏结束流程

### 3.1 游戏完成事件
当游戏结束时，机器人发送`gameFinish`事件到Socket服务器：

1. **数据收集**：
   - 收集所有玩家的游戏数据
   - 计算ELO变化
   - 确定获胜队伍

2. **数据处理**：
   - 更新玩家统计数据（胜场、败场、击杀、死亡等）
   - 计算新的ELO等级
   - 更新玩家的段位角色

3. **游戏报告**：
   - 在指定频道发送游戏报告
   - 报告包含各队伍玩家表现和ELO变化
   - @提及所有参与玩家

4. **资源清理**：
   - 删除临时游戏频道
   - 将玩家移回等待室
   - 释放机器人资源

### 3.2 ELO计算
- 使用专门的ELO算法计算玩家表现
- 根据玩家表现和胜负结果调整ELO分数
- 更新玩家的段位角色和昵称

## 4. 问题处理和复审流程

### 4.1 自动违规检测
系统会自动检测以下违规行为：
- **昵称漏洞**：检测玩家使用非法昵称
- **使用违禁物品**：检测玩家在游戏中使用违禁物品
- **AFK行为**：检测玩家在游戏中的挂机行为

### 4.2 违规处理
1. **自动处罚**：
   - 对检测到的违规行为自动添加违规点数
   - 根据违规严重程度施加临时封禁

2. **人工复审**：
   - 游戏报告发送到指定频道供管理员查看
   - 管理员可以手动调整游戏结果
   - 支持手动修改玩家统计数据

### 4.3 争议处理
虽然代码中没有明确的争议处理系统，但可以通过以下方式处理游戏争议：
1. 管理员查看游戏报告和相关数据
2. 使用管理命令手动调整玩家数据
3. 必要时联系相关玩家了解情况

## 5. 游戏状态管理

游戏具有以下状态：
- `PRE_GAME`：游戏创建初期状态
- `STARTING`：游戏准备开始状态
- `ACTIVE`：游戏正在进行状态
- `SCORING`：游戏评分处理状态
- `FINISHED`：游戏完成状态
- `VOID`：游戏取消状态

## 6. 分布式架构

系统采用分布式架构：
- 多个机器人实例可以同时运行
- 通过Socket.IO进行通信
- Socket服务器协调游戏分配和结果处理
- 支持负载均衡和故障转移